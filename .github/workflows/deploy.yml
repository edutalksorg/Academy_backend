- name: Deploy on Server
  uses: appleboy/ssh-action@v1.1.0
  with:
    host: ${{ secrets.SSH_HOST }}
    username: ${{ secrets.SSH_USERNAME }}
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    script: |
      set -e

      VERSION="${{ steps.version.outputs.version }}"
      BASE_DIR="/home/ubuntu/Academy_backend"
      DEPLOY_DIR="$BASE_DIR/deployments"
      RELEASES_DIR="$BASE_DIR/releases"
      RELEASE_DIR="$RELEASES_DIR/$VERSION"
      SHARED_DIR="$BASE_DIR/shared"
      ZIP_FILE="backend_${VERSION}.zip"

      echo "ðŸš€ Deploying version: $VERSION"

      # Ensure base folders exist
      mkdir -p "$DEPLOY_DIR" "$RELEASES_DIR" "$SHARED_DIR"

      # ðŸ”¥ CRITICAL FIX: remove any existing release directory
      if [ -d "$RELEASE_DIR" ]; then
        echo "ðŸ§¹ Removing old release directory"
        rm -rf "$RELEASE_DIR"
      fi

      # Create clean release directory
      mkdir -p "$RELEASE_DIR"

      # Extract fresh code ONLY
      unzip -q "$DEPLOY_DIR/$ZIP_FILE" -d "$RELEASE_DIR"

      # Link shared .env
      ln -sfn "$SHARED_DIR/.env" "$RELEASE_DIR/.env"

      # Install production dependencies
      cd "$RELEASE_DIR"
      npm ci --omit=dev

      # Switch current symlink
      ln -sfn "$RELEASE_DIR" "$BASE_DIR/current"

      # Restart PM2 CLEANLY
      cd "$BASE_DIR/current"
      pm2 delete backend || true
      pm2 start src/server.js --name backend --update-env
      pm2 save

      echo " Deployment completed successfully"
